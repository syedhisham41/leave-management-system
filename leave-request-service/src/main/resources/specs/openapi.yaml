openapi: 3.1.0
info:
  title: Leave Request Service API
  version: "1.0.0"
  description: |
    API for Leave Request Service. Paths and behavior match the existing implementation.
    Security: JWT `Authorization: Bearer <token>` for user access, or internal calls via `X-Service-Auth` header.
servers:
  - url: http://localhost:8081

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: >
        JWT token. Header example: `Authorization: Bearer <jwt>`.
        Note: role checks (EMPLOYEE / MANAGER / ADMIN) are enforced by service logic.
    serviceAuth:
      type: apiKey
      in: header
      name: X-Service-Auth
      description: Internal service secret header. Used for internal calls.
  parameters:
    X-Internal-Call:
      name: X-Internal-Call
      in: header
      schema:
        type: string
        enum: ["true", "false"]
      required: false
      description: Optional header used by handlers to skip certain validations when set to "true".
    employeeIdQuery:
      name: employee_id
      in: query
      schema:
        type: integer
      description: Employee identifier. Also accepts `employeeid` as alias (supported by handler).
    employeeIdQueryAlt:
      name: employeeid
      in: query
      schema:
        type: integer
      description: Alias for employee_id.
    managerIdQuery:
      name: manager_id
      in: query
      schema:
        type: integer
      description: Manager identifier. Also accepts `managerid` as alias.
    managerIdQueryAlt:
      name: managerid
      in: query
      schema:
        type: integer
      description: Alias for manager_id.
    leaveIdQuery:
      name: leave_id
      in: query
      schema:
        type: integer
      description: Leave identifier. Also accepts `leaveid` as alias.
    leaveIdQueryAlt:
      name: leaveid
      in: query
      schema:
        type: integer
      description: Alias for leave_id.

  schemas:
    # Generic API response wrapper DTO_api_response<T>
    ApiResponse:
      type: object
      properties:
        message:
          type: string
        code:
          type: string
          description: Enum name like "LEAVE_REQUEST_CREATED" or "INVALID_REQUEST"
        http_code:
          type: integer
        data:
          description: Response payload; type depends on endpoint. May be object, array or primitive.
    # DTOs
    DTO_leave_request:
      type: object
      properties:
        leave_id:
          type: integer
          nullable: true
          description: Autogenerated by DB on create
        employee_id:
          type: integer
        start_date:
          type: string
          format: date
        end_date:
          type: string
          format: date
        leave_type:
          $ref: "#/components/schemas/Leave_types"
        half_day_type:
          $ref: "#/components/schemas/Half_day_types"
        reason:
          type: string
        status:
          $ref: "#/components/schemas/Leave_status"
        approver_id:
          type: integer
          nullable: true
        applied_on:
          type: string
          format: date-time
          nullable: true
        decision_on:
          type: string
          format: date-time
          nullable: true
        approver_comments:
          type: string
          nullable: true
      required:
        - employee_id
        - start_date
        - end_date
        - leave_type
      example:
        leave_id: 1
        employee_id: 8
        start_date: "2025-05-18"
        end_date: "2025-05-18"
        leave_type: SICK
        half_day_type: NONE
        reason: "not well. fever"
        status: PENDING
        applied_on: "2025-05-18T09:00:00Z"

    DTO_leave_balance_entry:
      type: object
      properties:
        employee_id:
          type: integer
        leave_type:
          $ref: "#/components/schemas/Leave_types"
        balance:
          type: number
          format: float
        last_updated:
          type: string
          format: date-time
      required:
        - employee_id
        - leave_type
      example:
        employee_id: 200
        leave_type: EARNED
        balance: 10.5
        last_updated: "2025-11-27T00:00:00Z"

    DTO_leave_audit_log:
      type: object
      properties:
        audit_id:
          type: integer
        leave_id:
          type: integer
        action:
          $ref: "#/components/schemas/Leave_action"
        performed_by:
          type: integer
        comments:
          type: string
          nullable: true
        performed_on:
          type: string
          format: date-time
          nullable: true
        leave_days:
          type: number
          format: double
          nullable: true
        approver_comments:
          type: string
          nullable: true
      example:
        audit_id: 11
        leave_id: 1
        action: APPLIED
        performed_by: 8
        comments: "Initial application"
        performed_on: "2025-05-18T09:00:00Z"
        leave_days: 1.0
        approver_comments: null

    DTO_leave_request_approval_action:
      type: object
      properties:
        approver_id:
          type: integer
        leave_id:
          type: integer
        action:
          $ref: "#/components/schemas/Leave_action"
        comments:
          type: string
          nullable: true
      required:
        - approver_id
        - leave_id
        - action
      example:
        approver_id: 1
        leave_id: 10
        action: REJECTED
        comments: "reason for the leave request is not justified"

    DTO_employee_created_event:
      type: object
      properties:
        employee_id:
          type: integer
        emp_department_id:
          type: string
      required:
        - employee_id
      example:
        employee_id: 200
        emp_department_id: "ENG"

    DTO_employee_deleted_event:
      type: object
      properties:
        employee_id:
          type: integer
      required:
        - employee_id
      example:
        employee_id: 200

    # Enums
    Leave_types:
      type: string
      enum:
        - SICK
        - CASUAL
        - EARNED
        - WFH
        - BEREAVEMENT
        - MATERNITY
        - PATERNITY

    Half_day_types:
      type: string
      enum:
        - NONE
        - FIRST_DAY_HALF
        - LAST_DAY_HALF
        - BOTH

    Leave_action:
      type: string
      enum:
        - APPLIED
        - APPROVED
        - REJECTED
        - CANCELLED
        - AUTO_REJECTED
      description: |
        NOTE: The server's DTO Leave_action accepts a variety of text forms
        (e.g., "approve" => APPROVED, "reject" => REJECTED). Service logic performs the mapping.

    Leave_status:
      type: string
      enum:
        - PENDING
        - APPROVED
        - REJECTED
        - CANCELLED

  responses:
    Unauthorized:
      description: Missing or invalid JWT or internal service secret
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ApiResponse"
          example:
            message: "Missing Authorization header"
            code: "UNAUTHORIZED_ERROR"
            http_code: 401
            data: null
    Forbidden:
      description: Insufficient privileges
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ApiResponse"
          example:
            message: "Forbidden"
            code: "FORBIDDEN_ERROR"
            http_code: 403
            data: null
    BadRequest:
      description: Bad request / validation error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ApiResponse"
    InternalError:
      description: Server error
      content:
        application/json:
          schema:
            $ref: "#/components/schemas/ApiResponse"

paths:
  /leaverequest:
    post:
      summary: Create (apply) a new leave request
      tags:
        - LeaveRequest
      security:
        - bearerAuth: [] # employee JWT required
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DTO_leave_request"
            example:
              employee_id: 8
              start_date: "2025-05-18"
              end_date: "2025-05-18"
              leave_type: SICK
              half_day_type: NONE
              reason: "not well. fever"
      responses:
        "201":
          description: Leave Request created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponse"
              example:
                message: "Leave Request created successfully"
                code: "LEAVE_REQUEST_CREATED"
                http_code: 201
                data: 1
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /leaverequest/get:
    get:
      summary: Get leave requests
      tags:
        - LeaveRequest
      description: |
        Query options:
        - `employee_id` (or `employeeid`) — returns all leaves for that employee (employee self or admin)
        - `manager_id` (or `managerid`) — returns leaves for employees managed by that manager (manager only or admin)
        - `leave_id` (or `leaveid`) — returns the leave with that id (employee if own, manager/admin)
        - No query params — admin returns all leaves
      parameters:
        - $ref: "#/components/parameters/employeeIdQuery"
        - $ref: "#/components/parameters/employeeIdQueryAlt"
        - $ref: "#/components/parameters/managerIdQuery"
        - $ref: "#/components/parameters/managerIdQueryAlt"
        - $ref: "#/components/parameters/leaveIdQuery"
        - $ref: "#/components/parameters/leaveIdQueryAlt"
      security:
        - bearerAuth: [] # JWT required (employee/manager/admin). Service enforces role and ownership checks.
      responses:
        "200":
          description: Leave Request(s) fetched successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponse"
              example:
                message: "Leave Request fetched successfully"
                code: "LEAVE_REQUEST_FETCHED"
                http_code: 200
                data:
                  - leave_id: 1
                    employee_id: 8
                    start_date: "2025-05-18"
                    end_date: "2025-05-18"
                    leave_type: SICK
                    half_day_type: NONE
                    reason: "not well. fever"
                    status: PENDING
                    applied_on: "2025-05-18T09:00:00Z"
        "204":
          description: Leave Request list is empty
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponse"
              example:
                message: "Leave Request list is empty"
                code: "LEAVE_REQUEST_LIST_EMPTY"
                http_code: 204
                data: null
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /leaveapproval:
    put:
      summary: Approve, reject or cancel a leave
      tags:
        - LeaveApproval
      description: |
        Approve/Reject: Requires Manager or Admin JWT (service enforces role).
        Cancel: Employee may cancel own leave (service enforces ownership). Internal calls allowed for auto-cancel flows.
      security:
        - bearerAuth: [] # manager/admin for approve/reject, employee for cancel (enforced by service)
        - serviceAuth: [] # internal calls permitted (alternative)
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DTO_leave_request_approval_action"
            example:
              approver_id: 1
              leave_id: 10
              action: REJECTED
              comments: "reason for the leave request is not justified"
      responses:
        "200":
          description: Leave approval action processed (APPROVED / REJECTED / CANCELLED)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponse"
              examples:
                approve:
                  value:
                    message: "Leave request Approved"
                    code: "LEAVE_REQUEST_APPROVED"
                    http_code: 200
                    data: "Leave request Approved"
                reject:
                  value:
                    message: "Leave request Rejected"
                    code: "LEAVE_REQUEST_REJECTED"
                    http_code: 200
                    data: "Leave request Rejected"
                cancel:
                  value:
                    message: "Leave request Cancelled"
                    code: "LEAVE_REQUEST_CANCELLED"
                    http_code: 200
                    data: "Leave request Cancelled"
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /leavebalance/create:
    post:
      summary: Create leave balances for an employee (initialise)
      tags:
        - LeaveBalance
      description: |
        Creates leave balance records for all leave types for an employee.
        Allowed callers: internal service (X-Service-Auth) OR Admin JWT.
      security:
        - serviceAuth: [] # internal
        - bearerAuth: [] # Admin JWT alternative (service enforces admin role)
      parameters:
        - $ref: "#/components/parameters/X-Internal-Call"
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/DTO_employee_created_event"
            example:
              employee_id: 200
              emp_department_id: "ENG"
      responses:
        "201":
          description: Leave Balance created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponse"
              example:
                message: "Leave Balance created successfully"
                code: "LEAVE_BALANCE_CREATED"
                http_code: 201
                data: 6
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /leavebalance/delete:
    delete:
      summary: Delete all leave balance records for an employee
      tags:
        - LeaveBalance
      description: "Delete all leave balance records for an employee. Allowed callers: internal service (X-Service-Auth) OR Admin JWT."
      security:
        - serviceAuth: []
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                employee_id:
                  type: integer
              required:
                - employee_id
            example:
              employee_id: 38
      responses:
        "200":
          description: Leave Balance deleted successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponse"
              example:
                message: "Leave Balance deleted successfully"
                code: "LEAVE_BALANCE_DELETED"
                http_code: 200
                data: 1
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"

  /audit/get:
    get:
      summary: Get leave audit logs
      tags:
        - Audit
      description: |
        Query options:
        - `employee_id` — audit logs relating to an employee (employee self or manager/admin)
        - `leaveid` or `leave_id` — logs for that leave id
        - no query — admin returns all audit logs
      parameters:
        - $ref: "#/components/parameters/employeeIdQuery"
        - $ref: "#/components/parameters/employeeIdQueryAlt"
        - $ref: "#/components/parameters/leaveIdQuery"
        - $ref: "#/components/parameters/leaveIdQueryAlt"
      security:
        - bearerAuth: []
      responses:
        "200":
          description: Leave Audit Log fetched successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponse"
              example:
                message: "Leave Audit Log fetched successfully"
                code: "LEAVE_AUDIT_LOG_FETCHED"
                http_code: 200
                data:
                  - audit_id: 11
                    leave_id: 1
                    action: APPLIED
                    performed_by: 8
                    comments: "Initial application"
                    performed_on: "2025-05-18T09:00:00Z"
                    leave_days: 1.0
                    approver_comments: null
        "204":
          description: Audit list is empty
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ApiResponse"
              example:
                message: "Leave Audit Log fetched successfully"
                code: "LEAVE_AUDIT_LOG_FETCHED"
                http_code: 204
                data: null
        "400":
          $ref: "#/components/responses/BadRequest"
        "401":
          $ref: "#/components/responses/Unauthorized"
        "403":
          $ref: "#/components/responses/Forbidden"
        "500":
          $ref: "#/components/responses/InternalError"
